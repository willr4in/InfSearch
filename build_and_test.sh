#!/bin/bash
#
# Скрипт для полной сборки C++ ядра и запуска интеграционных тестов.
# Обеспечивает повторяемость выполнения тестового плана "с нуля".
# При возникновении любой ошибки выполнение скрипта будет прервано.
#
set -e

# --- ШАГ 1: Очистка предыдущих сборок ---
echo "--- Очистка старых артефактов сборки..."
rm -rf core_cpp/build
echo "Старая директория сборки core_cpp/build удалена."
echo ""

# --- ШАГ 2: Сборка C++ ядра ---
echo "--- Начало сборки C++ ядра с помощью CMake..."

# Создание новой директории для сборки
mkdir -p core_cpp/build

# Конфигурация проекта CMake
echo "Конфигурация CMake..."
cmake -S core_cpp -B core_cpp/build

# Компиляция проекта
echo "Компиляция проекта..."
cmake --build core_cpp/build

echo "--- Сборка C++ ядра успешно завершена. Библиотека libcore.so создана в core_cpp/build/."
echo ""

# --- ШАГ 3: Запуск автотестов ---
echo "--- Запуск интеграционных тестов с помощью pytest..."
python3 -m pytest tests/test_cpp_core.py

echo ""
echo "--- Все тесты успешно пройдены!"
echo "---"
echo "--- Сборка и тестирование успешно завершены."
echo "---"

